# NFT Widget: Complete Project Logic & Architecture

## ğŸ“‹ Table of Contents
1. [High-Level Architecture](#high-level-architecture)
2. [Wallet Detection System](#wallet-detection-system)
3. [Complete NFT Operation Flows](#complete-nft-operation-flows)
4. [Data Models & Types](#data-models--types)
5. [Frontend Component Responsibilities](#frontend-component-responsibilities)
6. [Backend Service Responsibilities](#backend-service-responsibilities)
7. [Request/Response Patterns](#requestresponse-patterns)
8. [Error Handling](#error-handling)
9. [Integration Checklist](#integration-checklist)

---

## High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           USER APPLICATION                          â”‚
â”‚                    (TextRP-Client or External Widget)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ POST /create-nft-offer
                          â”‚ POST /create-nft-buy-offer
                          â”‚ POST /accept-buy-or-sell-offer
                          â”‚ POST /cancel-nft-offer-with-sign
                          â”‚ POST /nft/submit-transaction
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TEXTRP-BACKEND                                  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ NFTController (routes.ts)                                    â”‚  â”‚
â”‚  â”‚ - Receives user request                                      â”‚  â”‚
â”‚  â”‚ - Validates credits                                          â”‚  â”‚
â”‚  â”‚ - Calls WalletDetectionService                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                           â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚         â–¼                                  â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ WalletDetectionService â”‚      â”‚ XummNftService /         â”‚      â”‚
â”‚  â”‚                        â”‚      â”‚ WalletConnectNftService  â”‚      â”‚
â”‚  â”‚ - Queries              â”‚      â”‚                          â”‚      â”‚
â”‚  â”‚   user_external_ids    â”‚      â”‚ - Builds unsigned XRPL   â”‚      â”‚
â”‚  â”‚   auth_provider        â”‚      â”‚   transactions           â”‚      â”‚
â”‚  â”‚                        â”‚      â”‚ - Returns Xumm payload   â”‚      â”‚
â”‚  â”‚ - Returns:             â”‚      â”‚   OR unsigned Txn        â”‚      â”‚
â”‚  â”‚   'xumm' |             â”‚      â”‚                          â”‚      â”‚
â”‚  â”‚   'walletconnect' |    â”‚      â”‚                          â”‚      â”‚
â”‚  â”‚   'unknown'            â”‚      â”‚                          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ Response: { type, transaction/QR, ... }
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   FRONTEND WIDGET                                   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ NFTSigningModal / NFTMarketplaceDialog                       â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚ if (response.type === 'xumm'):                             â”‚  â”‚
â”‚  â”‚   - Show QR code                                            â”‚  â”‚
â”‚  â”‚   - Connect WebSocket                                       â”‚  â”‚
â”‚  â”‚   - Poll for signature                                      â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚ if (response.type === 'walletconnect'):                    â”‚  â”‚
â”‚  â”‚   - Show transaction preview                                â”‚  â”‚
â”‚  â”‚   - Use WalletConnect to sign (Joey mobile)                â”‚  â”‚
â”‚  â”‚   - POST signed to /nft/submit-transaction                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ Joey Mobile App (WalletConnect)
                          â”‚ Xumm Mobile/Desktop (Xumm SDK)
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     XRPL BLOCKCHAIN                                 â”‚
â”‚                 (xrpl.com / Testnet)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Wallet Detection System

### How it Works
1. During **login**, user authenticates via wallet (Joey/Xumm).
2. Backend stores `auth_provider` in `user_external_ids.authProvider` field.
3. When user initiates NFT operation, backend **automatically detects** which wallet they used.
4. Different code paths are taken based on detected wallet.

### Database Table: `user_external_ids`
```sql
CREATE TABLE user_external_ids (
  id PRIMARY KEY,
  user_id VARCHAR,           -- Matrix user ID or internal user ID
  external_id VARCHAR,       -- XRPL wallet address
  auth_provider VARCHAR,     -- 'xrpl-jwt-walletconnect' | 'xrpl-jwt-xumm'
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);

-- Example rows:
-- | 1 | @alice:matrix.org | rN7n7otQDd6FczFgLdSqtcsAUxDkw6fzRH | xrpl-jwt-walletconnect |
-- | 2 | @bob:matrix.org   | rDVn2EdxFnEPkdPc9hpZgafrdS4EMd1wtV   | xrpl-jwt-xumm          |
```

### WalletDetectionService.detectWalletProvider()
```typescript
// File: app/Services/WalletDetectionService.ts

public static async detectWalletProvider(userAddress: string): Promise<'xumm' | 'walletconnect' | 'unknown'> {
  // Step 1: Find user in database by address
  let externalUser = await UserExternalId.query()
    .where('external_id', userAddress)
    .first();

  if (!externalUser) {
    // Try Matrix ID match
    externalUser = await UserExternalId.query()
      .whereRaw('LOWER(user_id) = LOWER(?)', [userAddress])
      .first();
  }

  // Step 2: Check auth_provider field
  const authProvider = externalUser.authProvider.toLowerCase();

  if (authProvider.includes('walletconnect')) {
    return 'walletconnect';  // Joey, Atomic, Bifrost, etc.
  } else if (authProvider.includes('xumm') || authProvider.includes('xaman')) {
    return 'xumm';           // Xumm mobile/desktop
  } else {
    return 'unknown';
  }
}
```

### Return Values
| Provider | Usage | Device |
|----------|-------|--------|
| `'xumm'` | Show QR code + WebSocket polling | Mobile / Desktop |
| `'walletconnect'` | Send unsigned txn + mobile signing | Mobile (Joey, Atomic, etc.) |
| `'unknown'` | Error: wallet not supported | N/A |

---

## Complete NFT Operation Flows

### Flow 1: Create Sell / Transfer Offer

#### 1a. User Initiates (Frontend)
```typescript
// NFTMarketplaceDialog.tsx
const response = await axios.post(
  `${backendUrl}/create-nft-offer`,
  {
    sender: "rN7n7otQDd6FczFgLdSqtcsAUxDkw6fzRH",    // User's address
    receiver: "all",                                   // Open to all buyers
    nft: "000100000000000000000000...",                // NFT ID
    amount: "50.5"                                     // XRP price (or "" for transfer)
  }
);

// Step A: Extract wallet type from response
const { type } = response.data;  // 'xumm' or 'walletconnect'

// Step B: Pass response to signing modal
setSigningData(response.data);
setWalletType(type === 'walletconnect' ? 'walletconnect' : 'xumm');
setShowSigningModal(true);
```

#### 1b. Backend Processing (NFTController.createSellOrTransferOffer)
```typescript
// File: app/Controllers/Http/NFTController.ts

public static async createSellOrTransferOffer(
  sender: string,      // "rN7n7otQDd6FczFgLdSqtcsAUxDkw6fzRH"
  receiver: string,    // "all"
  nft: string,         // "000100000000000000000000..."
  amount: string       // "50.5"
) {
  // ====== STEP 1: VALIDATE CREDITS ======
  const user = await User.query().where('address', sender).first();
  const userId = user.id;
  const userCredits = await UserCredit.query().where('user_id', userId).first();
  
  const requiredCredit = (await PlatformSetting.query()
    .where('key', amount === '' ? 'create_transfer_offer' : 'create_sell_offer')
    .firstOrFail()).value;
  
  if (userCredits.balance < requiredCredit) {
    return { result: 'NotEnoughCredit' };  // Reject
  }

  // ====== STEP 2: DETECT WALLET ======
  const walletProvider = await WalletDetectionService.detectWalletProvider(sender);
  // Returns: 'xumm' | 'walletconnect' | 'unknown'

  // ====== STEP 3: ROUTE TO APPROPRIATE SERVICE ======
  if (walletProvider === 'xumm') {
    // *** XUMM PATH ***
    return await XummNftService.createSellOrTransferOfferPayload(
      sender, receiver, nft, amount
    );
    // Returns: { user_token: "...", created: { refs: { qr_png: "...", websocket_status: "wss://..." } } }

  } else if (walletProvider === 'walletconnect') {
    // *** WALLETCONNECT PATH ***
    const prepared = await WalletConnectNftService.createSellOrTransferOfferTxn(
      sender, receiver, nft, amount
    );
    // Returns: unsigned XRPL transaction with all fields auto-filled
    // { TransactionType: "NFTokenCreateOffer", Account: "...", Destination: "...", ... }
    
    return {
      type: 'walletconnect',
      transaction: prepared,     // â† Send unsigned txn to frontend
      wallet: 'walletconnect'
    };
  }
}
```

#### 1c. XummNftService (Xumm User Path)
```typescript
// File: app/Services/XummNftService.ts

public static async createSellOrTransferOfferPayload(
  sender: string,
  receiver: string,
  nft: string,
  amount: string
) {
  // Use Xumm SDK to create a payload
  // Backend generates QR code + WebSocket endpoint
  
  const xummService = new XummService();
  const payload = {
    txjson: {
      TransactionType: 'NFTokenCreateOffer',
      Account: sender,
      NFTokenID: nft,
      Amount: xrpl.xrpToDrops(amount),
      Destination: receiver === 'all' ? brokerAddress : receiver,
      Flags: 1  // Sell offer
    }
  };
  
  const created = await xummService.xummPost('/payload', payload);
  // created.refs.qr_png = "https://qr.xumm.app/..."
  // created.refs.websocket_status = "wss://xumm.app/.../{uuid}"
  
  return {
    user_token: created.uuid,
    created: created  // â† Frontend uses qr_png and websocket_status
  };
}
```

#### 1d. WalletConnectNftService (Joey User Path)
```typescript
// File: app/Services/WalletConnectNftService.ts

public static async createSellOrTransferOfferTxn(
  sender: string,
  receiver: string,
  nft: string,
  amount: string
) {
  const client = new xrpl.Client('wss://s1.ripple.com');
  await client.connect();

  // Build unsigned transaction
  const txn = {
    TransactionType: 'NFTokenCreateOffer',
    Account: sender,
    NFTokenID: nft,
    Amount: xrpl.xrpToDrops(amount),   // Convert XRP to drops
    Destination: receiver === 'all' ? brokerAddress : receiver,
    Flags: 1                            // Sell offer flag
  };

  // Auto-fill missing fields (Sequence, Fee, LastLedgerSequence)
  const prepared = await client.autofill(txn);
  // prepared = {
  //   TransactionType: "NFTokenCreateOffer",
  //   Account: "rN7n7otQDd6FczFgLdSqtcsAUxDkw6fzRH",
  //   Amount: "50500000",     // 50.5 XRP in drops
  //   Sequence: 100738514,
  //   Fee: "12",
  //   LastLedgerSequence: 101076064
  //   ...
  // }

  await client.disconnect();
  return prepared;  // â† Return unsigned, frontend will send to Joey
}
```

#### 1e. Frontend Shows Signing Modal
```typescript
// NFTSigningModal.tsx

if (response.type === 'xumm') {
  // *** XUMM PATH ***
  // Show QR code
  <img src={response.created.refs.qr_png} />
  
  // Connect WebSocket
  const ws = new WebSocket(response.created.refs.websocket_status);
  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.signed === true) {
      // Success! Transaction signed by Xumm
      setStatus('success');
      onSuccess(data.txid);  // Don't need to submit, Xumm did it
    }
  };

} else if (response.type === 'walletconnect') {
  // *** WALLETCONNECT PATH ***
  // Show transaction preview
  <div>
    <p>Type: {response.transaction.TransactionType}</p>
    <p>Amount: {response.transaction.Amount} drops</p>
    <button onClick={handleWalletConnectSign}>Sign with Wallet</button>
  </div>

  // User clicks Sign button
  const handleWalletConnectSign = async () => {
    // Step 1: Detect Joey (or other wallet)
    const wallet = window.joeyWallet;  // Injected by Joey extension
    
    // Step 2: Request signature from Joey
    const signedTx = await wallet.signTransaction(response.transaction);
    // User taps "Sign" in Joey app on mobile
    // Joey signs with user's private key
    // Returns signed transaction with TxnSignature field

    // Step 3: Submit signed transaction to backend
    const submitRes = await fetch(`${backendUrl}/nft/submit-transaction`, {
      method: 'POST',
      body: JSON.stringify({
        signedTransaction: signedTx,
        transactionType: 'sell',
        sender: userAddress
      })
    });

    const result = await submitRes.json();
    // result = { success: true, txid: "AB1234...", type: 'walletconnect' }
    
    setStatus('success');
    onSuccess(result.txid);
  };
}
```

#### 1f. Submit Signed Transaction (WalletConnect Only)
```typescript
// Frontend, after Joey signs:

const result = await fetch(`/nft/submit-transaction`, {
  method: 'POST',
  body: JSON.stringify({
    signedTransaction: {
      TransactionType: "NFTokenCreateOffer",
      Account: "rN7n7otQDd6FczFgLdSqtcsAUxDkw6fzRH",
      Amount: "50500000",
      Sequence: 100738514,
      Fee: "12",
      LastLedgerSequence: 101076064,
      TxnSignature: "3045022100AB1234CD..."  // â† ADDED BY JOEY
    },
    transactionType: 'sell',
    sender: "rN7n7otQDd6FczFgLdSqtcsAUxDkw6fzRH"
  })
});

// Backend (NFTController.submitWalletConnectTransaction):
public static async submitWalletConnectTransaction(
  signedTransaction: any,
  transactionType: string,
  sender: string
) {
  const client = new xrpl.Client('wss://s1.ripple.com');
  await client.connect();

  // Submit to XRPL
  const result = await client.submitAndWait(signedTransaction);
  
  // Deduct credits
  await NFTController.deductCredit(sender, 'create_sell_offer');

  await client.disconnect();

  return {
    success: true,
    txid: result.result.hash,
    type: 'walletconnect'
  };
}
```

---

### Flow 2: Create Buy Offer (Summary)

```
Frontend POST /create-nft-buy-offer
  â†“
NFTController.createNftBuyOffer(nftId, bidPrice, owner, account)
  â”œâ”€ Validate credits
  â”œâ”€ Detect wallet (Xumm or WalletConnect)
  â”œâ”€ XummNftService.createNftBuyOfferPayload()
  â”‚   â””â”€ Returns: { user_token, created: { refs: { qr_png, websocket_status } } }
  â””â”€ WalletConnectNftService.createNftBuyOfferTxn()
      â””â”€ Returns: { type: 'walletconnect', transaction: { ... } }
  â†“
Frontend shows modal (Xumm QR OR WalletConnect signing)
  â”œâ”€ Xumm: show QR, poll WebSocket, done
  â””â”€ WalletConnect: show preview, user signs in Joey, POST /nft/submit-transaction
```

### Flow 3: Accept Offer (Similar Pattern)

```
Frontend POST /accept-buy-or-sell-offer
  â”œâ”€ body: { address, OfferId, buyOrSell }
  â†“
NFTController.acceptBuyOrSellOffer()
  â”œâ”€ Detect wallet
  â”œâ”€ XummNftService.acceptOfferPayload()
  â””â”€ WalletConnectNftService.acceptOfferTxn()
  â†“
Frontend â†’ Modal â†’ Sign (Xumm QR or Joey)
```

### Flow 4: Cancel Offer (Similar Pattern)

```
Frontend POST /cancel-nft-offer-with-sign
  â”œâ”€ body: { account, offerId }
  â†“
NFTController.cancelNftOfferWithSign()
  â”œâ”€ Detect wallet
  â”œâ”€ XummNftService.cancelOfferPayload()
  â””â”€ WalletConnectNftService.cancelOfferTxn()
  â†“
Frontend â†’ Modal â†’ Sign (Xumm QR or Joey)
```

---

## Data Models & Types

### Request Body Types

#### createSellOrTransferOffer
```typescript
{
  sender: string;      // XRPL address of seller
  receiver: string;    // XRPL address of buyer OR "all" for open offer
  nft: string;         // NFTokenID (hex string)
  amount: string;      // XRP amount (empty "" = transfer, not sale)
}
```

#### createNftBuyOffer
```typescript
{
  nft: string;         // NFTokenID
  amount: number | string;  // Bid price in XRP
  owner: string;       // Current owner
  account: string;     // Buyer address
}
```

#### acceptBuyOrSellOffer
```typescript
{
  address: string;     // Account accepting offer
  OfferId: string;     // Offer ID to accept
  buyOrSell: number;   // 0 = accept sell (you buy), 1 = accept buy (you sell)
}
```

#### cancelNftOfferWithSign
```typescript
{
  account: string;     // Account cancelling offer
  offerId: string;     // Offer ID to cancel
}
```

#### submitWalletConnectTransaction (WalletConnect Only)
```typescript
{
  signedTransaction: any;      // Signed XRPL txn from wallet
  transactionType: string;     // 'sell' | 'buy' | 'accept' | 'cancel'
  sender: string;              // Signer address
}
```

### Response Types

#### Xumm Response
```typescript
{
  user_token: string;
  created: {
    uuid: string;
    refs: {
      qr_png: string;              // QR code image URL
      websocket_status: string;    // WebSocket URL for polling
      xumm_app_url: string;        // Deep link to Xumm app
    }
  }
}
```

#### WalletConnect Response
```typescript
{
  type: 'walletconnect';
  transaction: {
    TransactionType: 'NFTokenCreateOffer' | 'NFTokenCreateOffer' | 'NFTokenAcceptOffer' | 'NFTokenCancelOffer';
    Account: string;
    Amount?: string;
    NFTokenID?: string;
    NFTokenSellOffer?: string;
    NFTokenBuyOffer?: string;
    NFTokenOffers?: string[];
    Sequence: number;
    Fee: string;
    LastLedgerSequence: number;
  };
  wallet: 'walletconnect';
}
```

#### Submit Transaction Response
```typescript
{
  success: boolean;
  txid: string;                // XRPL transaction hash
  type: 'walletconnect';
}
```

---

## Frontend Component Responsibilities

### NFTMarketplaceDialog
**Purpose**: Main container for NFT operations. Handles user interaction and API calls.

**Responsibilities**:
1. Display NFT list and selection UI
2. Collect user input (amount, receiver, etc.)
3. POST to `/create-nft-offer`, `/create-nft-buy-offer`, etc.
4. Extract wallet type from response: `const { type } = response.data`
5. Pass full response to NFTSigningModal
6. Set modal visibility and wallet type state

**Key State**:
```typescript
const [showSigningModal, setShowSigningModal] = useState(false);
const [signingData, setSigningData] = useState(null);
const [walletType, setWalletType] = useState('unknown');
const [selectedNFT, setSelectedNFT] = useState(null);
```

**Key Flow**:
```typescript
const response = await axios.post(`/create-nft-offer`, {
  sender, receiver, nft, amount
});

const { type } = response.data;
setWalletType(type === 'walletconnect' ? 'walletconnect' : 'xumm');
setSigningData(response.data);
setShowSigningModal(true);

<NFTSigningModal
  show={showSigningModal}
  response={signingData}
  walletType={walletType}
  sender={sender}
  onSuccess={handleSuccess}
/>
```

### NFTSigningModal
**Purpose**: Display appropriate signing UI based on wallet type. Handle both Xumm and WalletConnect flows.

**Responsibilities**:

#### For Xumm Users:
1. Extract QR PNG from `response.created.refs.qr_png`
2. Display QR code image
3. Connect to WebSocket: `response.created.refs.websocket_status`
4. Poll for signature completion
5. On success, close modal

```typescript
useEffect(() => {
  if (walletType !== 'xumm') return;

  const ws = new WebSocket(response.created.refs.websocket_status);
  
  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.signed === true) {
      setStatus('success');
      onSuccess(data.txid);  // txid from Xumm
      setTimeout(() => onClose(), 1500);
    }
  };

  return () => ws.close();
}, [walletType, response]);
```

#### For WalletConnect Users (Joey):
1. Show transaction preview
2. Detect installed wallet (Joey, Atomic, etc.)
3. Call `wallet.signTransaction(unsignedTx)`
4. Submit signed to `/nft/submit-transaction`
5. Display success with returned txid

```typescript
const handleWalletConnectSign = async () => {
  // Step 1: Detect wallet
  const wallet = (window as any).joeyWallet || (window as any).atomicWallet || ...;
  
  if (!wallet) {
    setErrorMessage('No wallet found. Install Joey or Atomic wallet.');
    return;
  }

  // Step 2: Sign
  const signedTx = await wallet.signTransaction(response.transaction);

  // Step 3: Submit to backend
  const submitRes = await fetch(`${backendUrl}/nft/submit-transaction`, {
    method: 'POST',
    body: JSON.stringify({
      signedTransaction: signedTx,
      transactionType: transactionType,
      sender: sender
    })
  });

  const result = await submitRes.json();
  
  // Step 4: Show success
  setStatus('success');
  onSuccess(result.txid);
  setTimeout(() => onClose(), 1500);
};
```

**Key State**:
```typescript
const [status, setStatus] = useState('pending' | 'signing' | 'success' | 'error');
const [isSubmitting, setIsSubmitting] = useState(false);
const [errorMessage, setErrorMessage] = useState('');
```

---

## Backend Service Responsibilities

### WalletDetectionService
**Purpose**: Determine which wallet a user is using.

**Key Method**:
```typescript
public static async detectWalletProvider(
  userAddress: string
): Promise<'xumm' | 'walletconnect' | 'unknown'>
```

**Logic**:
1. Query `user_external_ids` table by `external_id` (XRPL address)
2. Check `auth_provider` field
3. If includes 'walletconnect' â†’ return 'walletconnect'
4. If includes 'xumm' or 'xaman' â†’ return 'xumm'
5. Else â†’ return 'unknown'

---

### XummNftService
**Purpose**: Build Xumm SDK payloads for QR code + WebSocket flow.

**Key Methods**:
- `createSellOrTransferOfferPayload(sender, receiver, nft, amount)`
- `createNftBuyOfferPayload(nftId, bidPrice, owner, account)`
- `acceptOfferPayload(address, offerId, buyOrSell)`
- `cancelOfferPayload(account, offerId)`

**Behavior**:
- Use Xumm SDK to build payload
- Return `{ user_token, created: { refs: { qr_png, websocket_status } } }`
- Frontend shows QR, polls WebSocket
- Xumm submits to XRPL directly

---

### WalletConnectNftService
**Purpose**: Build unsigned XRPL transactions for WalletConnect/mobile wallets.

**Key Methods**:
- `createSellOrTransferOfferTxn(sender, receiver, nft, amount)`
- `createNftBuyOfferTxn(nftId, bidPrice, owner, account)`
- `acceptOfferTxn(address, offerId, buyOrSell)`
- `cancelOfferTxn(account, offerId)`

**Behavior**:
- Build unsigned XRPL transaction object
- Use `client.autofill()` to fill Sequence, Fee, LastLedgerSequence
- Return prepared transaction
- Frontend sends to Joey for signing
- Frontend submits signed to `/nft/submit-transaction`

---

### NFTController
**Purpose**: Orchestrate NFT operations. Entry point for all routes.

**Key Methods**:
```typescript
public static async createSellOrTransferOffer(sender, receiver, nft, amount)
public static async createNftBuyOffer(nftId, bidPriceXrp, owner, account)
public static async acceptBuyOrSellOffer(address, OfferId, buyOrSell)
public static async cancelNftOfferWithSign(account, offerId)
public static async submitWalletConnectTransaction(signedTransaction, transactionType, sender)
```

**Common Flow** (for all methods):
1. Validate user credits (deduct required amount)
2. Detect wallet provider: `WalletDetectionService.detectWalletProvider(userAddress)`
3. If Xumm: call `XummNftService.xxx()`
4. If WalletConnect: call `WalletConnectNftService.xxx()` and wrap in response
5. Return appropriate response

---

## Request/Response Patterns

### Pattern 1: Xumm User
```
Frontend POST /create-nft-offer
  â†“ Request { sender, receiver, nft, amount }
  â†“
Backend:
  1. Check credits
  2. Detect wallet â†’ 'xumm'
  3. Call XummNftService.createSellOrTransferOfferPayload()
  4. Return { user_token, created: { refs: { qr_png, websocket_status } } }
  â†“ Response
Frontend:
  1. Show QR code image
  2. Connect to WebSocket
  3. Poll until signed
  4. Close modal
```

### Pattern 2: WalletConnect User (Joey)
```
Frontend POST /create-nft-offer
  â†“ Request { sender, receiver, nft, amount }
  â†“
Backend:
  1. Check credits
  2. Detect wallet â†’ 'walletconnect'
  3. Call WalletConnectNftService.createSellOrTransferOfferTxn()
  4. Return { type: 'walletconnect', transaction: { ... }, wallet: 'walletconnect' }
  â†“ Response
Frontend:
  1. Show transaction preview
  2. User clicks "Sign with Wallet"
  3. Detect Joey: window.joeyWallet
  4. Call joeyWallet.signTransaction(transaction)
  5. Joey mobile app shows signing dialog
  6. User approves
  7. Joey returns signed transaction
  8. POST /nft/submit-transaction with signed transaction
  â†“ Request { signedTransaction, transactionType, sender }
Backend:
  1. client.submitAndWait(signedTransaction)
  2. Deduct credits
  3. Return { success: true, txid, type: 'walletconnect' }
  â†“ Response
Frontend:
  1. Show success message with txid
  2. Close modal
```

---

## Error Handling

### Frontend Error Cases

| Case | Handling |
|------|----------|
| No wallet detected | Show: "Your wallet is not supported. Install Joey or Xumm." |
| API call fails | Show: "Failed to create offer: {error message}" |
| User cancels signing | Close modal, reset state |
| Insufficient credits | Show: "Not enough credits for this operation" |
| Invalid wallet address | Show: "Invalid wallet address" |
| WalletConnect timeout | Show: "Signing timed out. Please try again." |
| XRPL submission fails | Show: "Transaction failed: {error}" |

### Backend Error Cases

| Case | Handling |
|------|----------|
| Wallet provider unknown | Throw: `Error('Unsupported wallet type')` |
| User not found | Return: `{ result: 'UserNotFound' }` |
| Insufficient credits | Return: `{ result: 'NotEnoughCredit' }` |
| XRPL connection error | Throw: `Error('XRPL connection failed')` |
| Invalid transaction | Return: `{ success: false, error: '...' }` |

### WalletConnect (Joey) Specific Errors

```typescript
try {
  const wallet = (window as any).joeyWallet;
  if (!wallet) {
    throw new Error('Joey Wallet not installed');
  }

  if (!wallet.signTransaction) {
    throw new Error('Joey Wallet does not support signing');
  }

  const signed = await wallet.signTransaction(unsignedTx);
  
  if (!signed.TxnSignature) {
    throw new Error('Joey did not return a valid signature');
  }
  
  // Continue...
} catch (error) {
  setErrorMessage(`Wallet error: ${error.message}`);
  setStatus('error');
}
```

---

## Integration Checklist

### For Frontend Widget Developer

- [ ] Import NFTSigningModal component
- [ ] Create NFTMarketplaceDialog or similar
- [ ] On user action, POST to correct `/create-*` route
- [ ] Extract `type` from response
- [ ] Pass full response to NFTSigningModal
- [ ] Handle both Xumm (QR) and WalletConnect (Joey) flows
- [ ] After signing, POST `/nft/submit-transaction` for WalletConnect only
- [ ] Display success message with txid
- [ ] Handle errors gracefully
- [ ] Test with both Xumm and Joey wallets

### For Backend Integration

- [ ] Ensure `user_external_ids.authProvider` is set during login
- [ ] Verify WalletDetectionService finds correct auth_provider
- [ ] Test both Xumm and WalletConnect paths
- [ ] Validate credit deduction logic
- [ ] Ensure XRPL submission works with signed transactions
- [ ] Return correct response shapes for each wallet type

### Required Environment Variables

**Frontend**:
```
REACT_APP_BACKEND_URL=https://api.textrp.io
REACT_APP_WALLETCONNECT_PROJECT_ID=<project_id>
```

**Backend**:
```
WALLET=wss://s1.ripple.com  # XRPL endpoint
BROKER_WALLET_ADDRESS=rN7n7otQDd6FczFgLdSqtcsAUxDkw6fzRH
SYSTEM_WALLET_SEED=sEd7...  # Broker's seed (for cancellations)
```

---

## Summary

**The key insight**:

1. **Wallet Detection** (automatic): Backend checks `auth_provider` field to know if user is Xumm or WalletConnect.
2. **Two Paths**: 
   - **Xumm**: Backend returns QR + WebSocket. Frontend shows QR. Xumm signs & submits.
   - **WalletConnect (Joey)**: Backend returns unsigned transaction. Frontend sends to Joey. Joey signs. Frontend submits to `/nft/submit-transaction`.
3. **Frontend's Job**: Detect wallet type from response and show correct UI + flow.
4. **Credits**: Deducted on every operation attempt.
5. **Signing**: User's private key never leaves their wallet (Joey/Xumm).

**For Your NFT Widget**:
- Check `response.type` first
- If 'walletconnect', handle Joey mobile signing + `/nft/submit-transaction` submission
- If 'xumm', handle QR + WebSocket polling
- Always show appropriate error messages

This architecture allows **both wallet types to work seamlessly** without duplicate code or manual routing on the frontend.
